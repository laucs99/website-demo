<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÊóÖÈÅäË°åÁ®ã v13 (Ëá™ÂãïÂÑ≤Â≠òÊèêÁ§∫Áâà)</title>
    <style>
        :root {
            --primary: #007aff;
            --bg: #f5f7fa;
            --text: #333;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", Helvetica, Arial, sans-serif;
            
            /* ÈáçË¶ÅË°åÁ®ãÈÖçËâ≤ (Ê∑∫ËóçÈ¢®Ê†º) */
            --imp-bg: #eef7ff;
            --imp-border: #007aff;
            --imp-text: #005bb5;
        }

        body {
            font-family: var(--font-stack);
            margin: 0; padding: 0; background-color: var(--bg); color: var(--text);
            padding-bottom: 80px;
        }

        /* --- Ê®ôÈ°åÂçÄ --- */
        .header-container { padding: 15px; background: white; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .title-input { font-family: var(--font-stack); font-size: 20px; font-weight: bold; border: none; border-bottom: 1px dashed #ccc; width: 100%; outline: none; background: transparent; }

        /* --- ÊéßÂà∂Èù¢Êùø --- */
        .control-panel { background: white; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .top-grid { display: grid; grid-template-columns: 1.1fr 1fr; gap: 15px; margin-bottom: 10px; }
        
        .calendar-widget { border: 1px solid #eee; border-radius: 8px; padding: 5px; }
        .cal-header { text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 5px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; }
        .cal-cell { font-size: 10px; padding: 3px 0; border-radius: 3px; color: #333; }
        .cal-head { color: #999; font-weight: bold; }
        .cal-cell.in-range { background: #e0f0ff; color: var(--primary); }
        .cal-cell.start-date, .cal-cell.end-date { background: var(--primary); color: white; font-weight: bold; }
        
        .date-input-mini { background: #f0f2f5; border-radius: 8px; padding: 8px; display: flex; flex-direction: column; margin-bottom: 5px; }
        .date-input-mini label { font-size: 10px; color: #666; margin-bottom: 2px; }
        .date-input-mini input { border: none; background: transparent; width: 100%; font-family: var(--font-stack); font-size: 13px; }

        /* --- ÁØ©ÈÅ∏Âàó --- */
        .filter-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-btn {
            border: 1px solid #ddd; background: white; color: #555;
            padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;
            cursor: pointer; white-space: nowrap; transition: 0.2s;
        }
        .filter-btn.active { background: #333; color: white; border-color: #333; }

        /* --- Êñ∞Â¢ûË°åÁ®ãÈù¢Êùø --- */
        .add-panel-container {
            margin: 10px 15px; background: white; border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden;
            border: 1px solid #e1e4e8;
        }
        .add-panel-header {
            padding: 12px 15px; background: #f8f9fa; font-weight: bold; color: var(--primary);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .add-panel-body { display: block; padding: 15px; background: white; }
        .add-panel-container.closed .add-panel-body { display: none; }
        .toggle-icon { transition: 0.3s; transform: rotate(0deg); }
        .add-panel-container.closed .toggle-icon { transform: rotate(-90deg); }

        .form-row { margin-bottom: 12px; }
        .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: var(--font-stack); font-size: 15px; box-sizing: border-box; }

        .day-select-container { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .day-opt-btn { flex: 0 0 auto; padding: 8px 10px; border-radius: 8px; background: #f1f3f5; color: #555; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .day-opt-btn b { display: block; font-size: 13px; margin-bottom: 2px; }
        .day-opt-btn.selected { background: #e7f5ff; border-color: var(--primary); color: var(--primary); }

        .label-options { display: flex; gap: 8px; flex-wrap: wrap; }
        .label-chip { padding: 5px 12px; border-radius: 15px; border: 1px solid #ddd; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .label-chip.selected { background: #333; color: white; border-color: #333; transform: scale(1.05); }

        .time-group { display: flex; align-items: center; gap: 5px; }
        .preview-area { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; scrollbar-width: none; }
        .preview-thumb-box { position: relative; width: 60px; height: 60px; flex-shrink: 0; }
        .preview-thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .remove-img-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; text-align: center; line-height: 18px; cursor: pointer; border: none; }

        .checkbox-row { display: flex; align-items: center; gap: 8px; color: var(--primary); font-weight: bold; font-size: 14px; }
        .btn-submit { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }

        /* --- ÂàóË°®È°ØÁ§∫ÂçÄ --- */
        .tabs-container { display: flex; overflow-x: auto; gap: 8px; padding: 0 15px 10px 15px; scrollbar-width: none; }
        .tab-btn { flex: 0 0 auto; padding: 6px 12px; border-radius: 8px; background: white; color: #888; text-align: center; font-size: 12px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tab-btn b { display: block; font-size: 13px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-btn.tab-all { font-family: "Arial Black", sans-serif; font-size: 18px; color: var(--primary); font-style: italic; display: flex; align-items: center; }
        .tab-btn.tab-all.active { background: var(--primary); color: white; }

        #list-area { padding: 0 15px; }

        .trip-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); position: relative;
            border: 1px solid transparent; 
            transition: 0.2s;
        }

        /* ÈáçË¶ÅË°åÁ®ãÈ¢®Ê†º */
        .trip-card.is-important {
            background-color: var(--imp-bg);
            border: 2px solid var(--imp-border);
        }

        .card-header { margin-bottom: 8px; }
        .card-badges { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 5px; }
        .badge { padding: 3px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; display: inline-block; }
        
        .card-title { font-size: 18px; font-weight: bold; color: #222; text-decoration: none; display: block; margin-bottom: 2px; }
        .card-time { font-size: 13px; color: #666; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; gap: 4px; }
        .card-desc { font-size: 13px; color: #555; margin-bottom: 8px; white-space: pre-wrap; line-height: 1.4; }

        .card-images-row { display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto; }
        .card-img-item { width: 70px; height: 70px; border-radius: 4px; object-fit: cover; background: #eee; cursor: zoom-in; }

        .card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 5px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05); }
        .footer-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

        .map-btn {
            font-size: 12px; color: #444; background: #e9ecef;
            padding: 5px 10px; border-radius: 15px; text-decoration: none;
            font-weight: bold; display: flex; align-items: center; gap: 4px;
        }
        .map-btn:hover { background: #dee2e6; }

        .day-label-pill {
            color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;
            text-shadow: 0 1px 1px rgba(0,0,0,0.2);
        }

        .yt-link {
            color: white; background: #ff0000; font-weight: bold; text-decoration: none; font-size: 12px;
            padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 4px;
            box-shadow: 0 2px 4px rgba(255,0,0,0.2);
        }

        .tag-important-text {
            color: var(--imp-text); font-size: 12px; font-weight: bold;
            background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 4px;
        }

        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .icon-btn { 
            border:none; background:rgba(255,255,255,0.8); cursor:pointer; font-size:14px; 
            color:#555; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .icon-btn:hover { background: white; color: black; }
        .icon-btn.delete { color: #ff3b30; }

        /* Lightbox & Modal */
        .lightbox-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 300; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .lightbox-overlay.active { display: flex; }
        .lightbox-img { max-width: 95%; max-height: 80vh; border-radius: 4px; }
        .lightbox-close { color: white; font-size: 30px; cursor: pointer; margin-bottom: 20px; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-body { background: white; width: 100%; padding: 25px; border-radius: 20px 20px 0 0; box-sizing: border-box; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }

        /* --- Ëá™ÂãïÂÑ≤Â≠òÊèêÁ§∫ (Toast) --- */
        #save-toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 14px; font-weight: bold; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 999; display: flex; align-items: center; gap: 5px;
        }
        #save-toast.show { opacity: 1; }

    </style>
</head>
<body>

    <!-- ÂÑ≤Â≠òÊèêÁ§∫ -->
    <div id="save-toast">‚úÖ Â∑≤Ëá™ÂãïÂÑ≤Â≠ò</div>

    <div class="header-container">
        <input type="text" id="trip-title" class="title-input" value="ÊàëÁöÑÊóÖÈÅäË°åÁ®ã" oninput="saveTitle()">
        <span class="icon-btn">‚úèÔ∏è</span>
    </div>

    <div class="control-panel">
        <div class="top-grid">
            <div class="calendar-widget">
                <div class="cal-header"><span id="cal-month-year"></span></div>
                <div class="cal-grid" id="calendar-grid"></div>
            </div>
            <div style="display:flex; flex-direction:column; justify-content:center;">
                <div class="date-input-mini">
                    <label>Âá∫ÁôºÊó•Êúü (Start)</label>
                    <input type="date" id="start-date" onchange="handleDateChange()">
                </div>
                <div class="date-input-mini">
                    <label>ÂõûÁ®ãÊó•Êúü (End)</label>
                    <input type="date" id="end-date" onchange="handleDateChange()">
                </div>
            </div>
        </div>
        <div class="filter-row">
            <button class="filter-btn active" onclick="applyFilter('all')">È°ØÁ§∫ÂÖ®ÈÉ®</button>
            <button class="filter-btn" onclick="applyFilter('ÁæéÈ£ü')">ÁæéÈ£ü</button>
            <button class="filter-btn" onclick="applyFilter('ËßÄÂÖâ')">ËßÄÂÖâ</button>
            <button class="filter-btn" onclick="applyFilter('Ë≥ºÁâ©')">Ë≥ºÁâ©</button>
            <button class="filter-btn" onclick="applyFilter('‰ΩèÂÆø')">‰ΩèÂÆø</button>
        </div>
    </div>

    <!-- Êñ∞Â¢ûË°åÁ®ã -->
    <div class="add-panel-container" id="add-panel">
        <div class="add-panel-header" onclick="toggleAddPanel()">
            <span>Ôºã Êñ∞Â¢ûË°åÁ®ã</span>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="add-panel-body">
            <div class="form-row">
                <label style="font-size:12px; color:#666; display:block; margin-bottom:5px;">ÈÅ∏ÊìáÊó•Êúü</label>
                <div class="day-select-container" id="add-day-buttons"></div>
            </div>
            
            <div class="form-row">
                <input type="text" id="add-name" class="form-input" placeholder="Âú∞Èªû / Â∫óÂêç">
            </div>

            <div class="form-row checkbox-row">
                <input type="checkbox" id="add-important">
                <label for="add-important">Ê®ôÁ§∫ÁÇ∫ÈáçË¶Å (Ê∑∫ËóçËÉåÊôØ)</label>
            </div>

            <div class="form-row">
                <label style="font-size:12px; color:#666; margin-bottom:5px;">ÂàÜÈ°ûÊ®ôÁ±§ (ÂèØÂ§öÈÅ∏)</label>
                <div class="label-options" id="add-label-opts"></div>
            </div>

            <div class="form-row">
                <textarea id="add-desc" class="form-input" rows="2" placeholder="ÂÇôË®ª..."></textarea>
            </div>
            
            <div class="form-row" style="display:flex; gap:10px;">
                <input type="url" id="add-yt" class="form-input" placeholder="YouTube ÈÄ£Áµê" style="flex:1;">
            </div>
            <div class="form-row time-group">
                <label style="font-size:13px; color:#666;">üïí</label>
                <input type="time" id="add-start-time" class="form-input">
                <span>-</span>
                <input type="time" id="add-end-time" class="form-input">
            </div>

            <div class="form-row">
                <input type="file" id="add-img" accept="image/*" multiple class="form-input">
                <div class="preview-area" id="add-img-preview"></div>
            </div>

            <button class="btn-submit" onclick="addItem()">ÂÑ≤Â≠òË°åÁ®ã</button>
        </div>
    </div>

    <div class="tabs-container" id="tabs-container"></div>
    <div id="list-area"></div>

    <!-- ÁáàÁÆ± -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <div class="lightbox-close">√ó ÈóúÈñâ</div>
        <img src="" class="lightbox-img" id="lightbox-img">
    </div>

    <!-- Á∑®ËºØ Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal-body">
            <h3>‰øÆÊîπË°åÁ®ã</h3>
            <div id="edit-form-content"></div>
        </div>
    </div>

    <script>
        const COLORS = { 'ÁæéÈ£ü': '#ff9500', 'ËßÄÂÖâ': '#34c759', 'Ë≥ºÁâ©': '#af52de', '‰ΩèÂÆø': '#5856d6', '‰∫§ÈÄö': '#a2845e' };
        const DAY_COLORS = ['#007aff', '#ff9500', '#34c759', '#ff2d55', '#5856d6', '#00c7be', '#af52de'];

        let tripData = [];
        let dateRange = [];
        let currentView = 'all'; 
        let currentFilter = 'all';
        
        let selectedAddDay = null;
        let selectedAddLabels = new Set(['ËßÄÂÖâ']);
        let tempAddImages = [];

        // Á∑®ËºØÁî®ÁöÑÊö´Â≠ò
        let editId = null;
        let tempEditImages = [];
        let selectedEditLabels = new Set();
        let toastTimeout = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderAddLabels();
        });

        // Ëá™ÂãïÂÑ≤Â≠òÊèêÁ§∫
        function showSaveToast() {
            const toast = document.getElementById('save-toast');
            toast.classList.add('show');
            if(toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 1500);
        }

        function saveTitle() { 
            localStorage.setItem('v13_title', document.getElementById('trip-title').value);
            // Ê®ôÈ°åËº∏ÂÖ•È†ªÁπÅÔºå‰∏çÊØèÊ¨°È°ØÁ§∫ ToastÔºåÈÅøÂÖçÈñÉÁàçÔºå‰ΩÜÁ¢∫ÂØ¶Â∑≤ÂÑ≤Â≠ò
        }
        function toggleAddPanel() { document.getElementById('add-panel').classList.toggle('closed'); }

        function handleDateChange() {
            const s = document.getElementById('start-date').value;
            const e = document.getElementById('end-date').value;
            localStorage.setItem('v13_start', s);
            localStorage.setItem('v13_end', e);
            if(!s || !e) return;
            if(e < s) { document.getElementById('end-date').value = s; return handleDateChange(); }

            dateRange = [];
            let curr = new Date(s);
            let last = new Date(e);
            while(curr <= last) {
                dateRange.push(curr.toISOString().split('T')[0]);
                curr.setDate(curr.getDate() + 1);
            }
            if(currentView !== 'all' && currentView >= dateRange.length) currentView = 'all';

            renderCalendarWidget();
            renderDayButtons();
            renderTabs();
            renderList();
            showSaveToast();
        }

        // --- Render Helpers ---
        function renderCalendarWidget() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('cal-month-year');
            const startVal = document.getElementById('start-date').value;
            const endVal = document.getElementById('end-date').value;
            if(!startVal) { title.innerText = ""; grid.innerHTML = ""; return; }
            
            const now = new Date(startVal);
            title.innerText = `${now.getFullYear()}Âπ¥ ${now.getMonth()+1}Êúà`;
            grid.innerHTML = "";
            ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].forEach(d => grid.innerHTML+=`<div class="cal-cell cal-head">${d}</div>`);
            
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML+=`<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                let cls = 'cal-cell';
                if(startVal && endVal) {
                    if(dateStr===startVal) cls+=' start-date';
                    else if(dateStr===endVal) cls+=' end-date';
                    else if(dateStr>startVal && dateStr<endVal) cls+=' in-range';
                } else if(dateStr===startVal) cls+=' start-date';
                grid.innerHTML+=`<div class="${cls}">${d}</div>`;
            }
        }

        function renderDayButtons() {
            const container = document.getElementById('add-day-buttons');
            container.innerHTML = '';
            if(!selectedAddDay && dateRange.length > 0) selectedAddDay = dateRange[0];
            dateRange.forEach((d, i) => {
                const dt = new Date(d);
                const btn = document.createElement('div');
                btn.className = `day-opt-btn ${selectedAddDay===d?'selected':''}`;
                btn.innerHTML = `<b>Day ${i+1}</b> ${dt.getMonth()+1}/${dt.getDate()}`;
                btn.onclick = () => { selectedAddDay = d; renderDayButtons(); };
                container.appendChild(btn);
            });
        }

        function renderAddLabels() {
            const box = document.getElementById('add-label-opts');
            box.innerHTML = '';
            Object.keys(COLORS).forEach(k => {
                const s = document.createElement('span');
                s.className = `label-chip ${selectedAddLabels.has(k)?'selected':''}`;
                s.innerText = k;
                s.onclick = () => { 
                    if(selectedAddLabels.has(k)) selectedAddLabels.delete(k);
                    else selectedAddLabels.add(k);
                    renderAddLabels(); 
                };
                box.appendChild(s);
            });
        }

        // --- Add Item ---
        function addItem() {
            const name = document.getElementById('add-name').value.trim();
            if(!name) { alert('Ë´ãËº∏ÂÖ•Â∫óÂêç'); return; }
            if(!selectedAddDay) { alert('Ë´ãÂÖàË®≠ÂÆöÊó•Êúü'); return; }

            const newItem = {
                id: Date.now(),
                date: selectedAddDay,
                name: name,
                labels: Array.from(selectedAddLabels),
                isImportant: document.getElementById('add-important').checked,
                desc: document.getElementById('add-desc').value,
                startTime: document.getElementById('add-start-time').value,
                endTime: document.getElementById('add-end-time').value,
                yt: document.getElementById('add-yt').value,
                images: [...tempAddImages]
            };

            tripData.push(newItem);
            localStorage.setItem('v13_data', JSON.stringify(tripData));
            
            // Ê∏ÖÁ©∫
            document.getElementById('add-name').value = '';
            document.getElementById('add-desc').value = '';
            document.getElementById('add-yt').value = '';
            document.getElementById('add-start-time').value = '';
            document.getElementById('add-end-time').value = '';
            document.getElementById('add-img').value = '';
            document.getElementById('add-important').checked = false;
            document.getElementById('add-img-preview').innerHTML = '';
            tempAddImages = [];
            renderList();
            showSaveToast();
        }

        // --- Render List ---
        function applyFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(b => {
                if(b.innerText.includes(type) || (type==='all' && b.innerText==='È°ØÁ§∫ÂÖ®ÈÉ®')) b.classList.add('active');
                else b.classList.remove('active');
            });
            renderList();
        }

        function renderTabs() {
            const con = document.getElementById('tabs-container');
            con.innerHTML = '';
            const all = document.createElement('div');
            all.className = `tab-btn tab-all ${currentView==='all'?'active':''}`;
            all.innerText = 'All';
            all.onclick = () => { currentView='all'; renderTabs(); renderList(); };
            con.appendChild(all);

            dateRange.forEach((d, i) => {
                const dt = new Date(d);
                const btn = document.createElement('div');
                btn.className = `tab-btn ${currentView===i?'active':''}`;
                btn.innerHTML = `<b>Day ${i+1}</b> ${dt.getMonth()+1}/${dt.getDate()}`;
                btn.onclick = () => { currentView = i; renderTabs(); renderList(); };
                con.appendChild(btn);
            });
        }

        function renderList() {
            const box = document.getElementById('list-area');
            box.innerHTML = '';
            if(dateRange.length === 0) { box.innerHTML = '<div style="text-align:center;color:#999;margin-top:20px;">Ë´ãË®≠ÂÆöÊó•Êúü</div>'; return; }

            let items = [];
            if(currentView === 'all') items = tripData.filter(i => dateRange.includes(i.date));
            else items = tripData.filter(i => i.date === dateRange[currentView]);

            items.sort((a,b) => {
                if(a.date !== b.date) return a.date > b.date ? 1 : -1;
                if(a.startTime && b.startTime) return a.startTime > b.startTime ? 1 : -1;
                return 0;
            });

            if(currentFilter !== 'all') {
                items = items.filter(i => {
                    const ls = Array.isArray(i.labels) ? i.labels : [i.label];
                    return ls.includes(currentFilter);
                });
            }

            items.forEach(item => {
                const dayIdx = dateRange.indexOf(item.date);
                const dayNum = dayIdx >= 0 ? `Day ${dayIdx+1}` : '';
                
                const dayColor = DAY_COLORS[dayIdx % DAY_COLORS.length] || '#666';

                let labelsHtml = '';
                const labelsArr = Array.isArray(item.labels) ? item.labels : [item.label];
                labelsArr.forEach(lbl => {
                    if(lbl) {
                        const c = COLORS[lbl] || '#999';
                        labelsHtml += `<span class="badge" style="background:${c}">${lbl}</span>`;
                    }
                });

                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.name)}`;
                
                let timeStr = '';
                if(item.startTime) timeStr += item.startTime;
                if(item.endTime) timeStr += ` - ${item.endTime}`;
                if(timeStr) timeStr = `üïí ${timeStr}`;

                let ytHtml = item.yt ? `<a href="${item.yt}" target="_blank" class="yt-link">‚ñ∂ YouTube</a>` : '';
                
                let impHtml = item.isImportant ? `<span class="tag-important-text">‚òÖ ÈáçË¶Å</span>` : '';
                let impClass = item.isImportant ? 'is-important' : '';

                let imgsHtml = '';
                if(item.images && item.images.length > 0) {
                    imgsHtml = '<div class="card-images-row">';
                    item.images.forEach(src => {
                        imgsHtml += `<img src="${src}" class="card-img-item" onclick="openLightbox('${src}')">`;
                    });
                    imgsHtml += '</div>';
                } else if (item.img) {
                    imgsHtml = `<div class="card-images-row"><img src="${item.img}" class="card-img-item" onclick="openLightbox('${item.img}')"></div>`;
                }

                const html = `
                    <div class="trip-card ${impClass}">
                        <div class="card-actions">
                            <button class="icon-btn" onclick="openEditModal(${item.id})">‚úèÔ∏è</button>
                            <button class="icon-btn delete" onclick="deleteItem(${item.id})">√ó</button>
                        </div>
                        
                        <div class="card-header">
                            <div class="card-badges">${labelsHtml}</div>
                            <a href="${mapUrl}" target="_blank" class="card-title">${item.name}</a>
                            <div class="card-time">${timeStr}</div>
                            <div class="card-desc">${item.desc || ''}</div>
                        </div>
                        ${imgsHtml}
                        <div class="card-footer">
                            <div class="footer-left">
                                <a href="${mapUrl}" target="_blank" class="map-btn">üìç Âú∞Âúñ</a>
                                <span class="day-label-pill" style="background:${dayColor}">${dayNum}</span>
                                ${impHtml}
                            </div>
                            ${ytHtml}
                        </div>
                    </div>
                `;
                box.innerHTML += html;
            });
        }

        function deleteItem(id) {
            if(confirm('Âà™Èô§?')) {
                tripData = tripData.filter(i => i.id !== id);
                localStorage.setItem('v13_data', JSON.stringify(tripData));
                renderList();
                showSaveToast();
            }
        }

        // --- Á∑®ËºØÂäüËÉΩ (Edit Modal) ---
        function openEditModal(id) {
            editId = id;
            const item = tripData.find(i => i.id === id);
            if(!item) return;

            selectedEditLabels = new Set(Array.isArray(item.labels) ? item.labels : [item.label]);
            tempEditImages = item.images ? [...item.images] : (item.img ? [item.img] : []);

            const modalContent = document.getElementById('edit-form-content');
            let dayOpts = '';
            dateRange.forEach((d,i) => dayOpts+=`<option value="${d}" ${d===item.date?'selected':''}>Day ${i+1}</option>`);

            modalContent.innerHTML = `
                <div class="form-row"><select id="e-day" class="form-input">${dayOpts}</select></div>
                <div class="form-row"><input type="text" id="e-name" class="form-input" value="${item.name}"></div>
                <div class="form-row checkbox-row">
                    <input type="checkbox" id="e-imp" ${item.isImportant?'checked':''}> <label for="e-imp">ÈáçË¶Å (Ê∑∫ËóçËÉåÊôØ)</label>
                </div>
                <div class="form-row"><div class="label-options" id="e-labels-box"></div></div>
                <div class="form-row"><input type="url" id="e-yt" class="form-input" value="${item.yt||''}" placeholder="YouTube URL"></div>
                <div class="form-row time-group">
                    <input type="time" id="e-start" class="form-input" value="${item.startTime||''}"> - 
                    <input type="time" id="e-end" class="form-input" value="${item.endTime||''}">
                </div>
                <div class="form-row"><textarea id="e-desc" class="form-input">${item.desc||''}</textarea></div>
                
                <div class="form-row">
                    <label style="font-size:12px;color:#666">ÁèæÊúâÂúñÁâá (ÈªûÊìäÂà™Èô§):</label>
                    <div class="preview-area" id="e-img-preview"></div>
                </div>
                <div class="form-row">
                    <label style="font-size:12px;color:#666">Êñ∞Â¢ûÂúñÁâá:</label>
                    <input type="file" id="e-img-add" accept="image/*" multiple class="form-input">
                </div>

                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button class="btn-submit" onclick="saveEdit()">ÂÑ≤Â≠òËÆäÊõ¥</button>
                    <button onclick="document.getElementById('edit-modal').classList.remove('active')" style="flex:1;border:1px solid #ddd;background:white;border-radius:8px;">ÂèñÊ∂à</button>
                </div>
            `;
            
            renderEditLabels();
            renderEditImages();
            document.getElementById('e-img-add').addEventListener('change', handleEditImageAdd);
            document.getElementById('edit-modal').classList.add('active');
        }

        function renderEditLabels() {
            const box = document.getElementById('e-labels-box');
            box.innerHTML = '';
            Object.keys(COLORS).forEach(k => {
                const s = document.createElement('span');
                s.className = `label-chip ${selectedEditLabels.has(k)?'selected':''}`;
                s.innerText = k;
                s.onclick = () => { 
                    if(selectedEditLabels.has(k)) selectedEditLabels.delete(k); else selectedEditLabels.add(k);
                    renderEditLabels(); 
                };
                box.appendChild(s);
            });
        }

        function renderEditImages() {
            const box = document.getElementById('e-img-preview');
            box.innerHTML = '';
            tempEditImages.forEach((src, idx) => {
                const div = document.createElement('div');
                div.className = 'preview-thumb-box';
                div.innerHTML = `<img src="${src}" class="preview-thumb"><button class="remove-img-btn" onclick="removeEditImage(${idx})">√ó</button>`;
                box.appendChild(div);
            });
        }

        window.removeEditImage = function(idx) {
            tempEditImages.splice(idx, 1);
            renderEditImages();
        }

        function handleEditImageAdd(e) {
            const files = e.target.files;
            if(!files) return;
            Array.from(files).forEach(file => {
                const r = new FileReader();
                r.onload = evt => {
                    const img = new Image(); img.src = evt.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        let w=img.width, h=img.height, m=300; 
                        if(w>h && w>m){h*=m/w;w=m} else if(h>m){w*=m/h;h=m}
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        tempEditImages.push(cvs.toDataURL('image/jpeg', 0.6));
                        renderEditImages();
                    }
                }
                r.readAsDataURL(file);
            });
        }

        function saveEdit() {
            const idx = tripData.findIndex(i => i.id === editId);
            if(idx !== -1) {
                tripData[idx].date = document.getElementById('e-day').value;
                tripData[idx].name = document.getElementById('e-name').value;
                tripData[idx].isImportant = document.getElementById('e-imp').checked;
                tripData[idx].labels = Array.from(selectedEditLabels);
                tripData[idx].yt = document.getElementById('e-yt').value;
                tripData[idx].startTime = document.getElementById('e-start').value;
                tripData[idx].endTime = document.getElementById('e-end').value;
                tripData[idx].desc = document.getElementById('e-desc').value;
                tripData[idx].images = [...tempEditImages];
                tripData[idx].img = null;
            }
            localStorage.setItem('v13_data', JSON.stringify(tripData));
            document.getElementById('edit-modal').classList.remove('active');
            renderList();
            showSaveToast();
        }

        // ÂúñÁâáËôïÁêÜ (Êñ∞Â¢ûÈù¢Êùø)
        document.getElementById('add-img').addEventListener('change', function(e) {
            const files = e.target.files;
            if(!files) return;
            Array.from(files).forEach(file => {
                const r = new FileReader();
                r.onload = evt => {
                    const img = new Image(); img.src = evt.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                        let w=img.width, h=img.height, m=300; 
                        if(w>h && w>m){h*=m/w;w=m} else if(h>m){w*=m/h;h=m}
                        cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h);
                        const b64 = cvs.toDataURL('image/jpeg', 0.6);
                        tempAddImages.push(b64);
                        const thumb = document.createElement('div');
                        thumb.className = 'preview-thumb-box';
                        thumb.innerHTML = `<img src="${b64}" class="preview-thumb">`;
                        document.getElementById('add-img-preview').appendChild(thumb);
                    }
                }
                r.readAsDataURL(file);
            });
        });

        // Lightbox
        function openLightbox(src) {
            document.getElementById('lightbox-img').src = src;
            document.getElementById('lightbox').classList.add('active');
        }
        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
        }

        function loadData() {
            const t = localStorage.getItem('v13_title');
            if(t) document.getElementById('trip-title').value = t;
            const s = localStorage.getItem('v13_start');
            const e = localStorage.getItem('v13_end');
            const d = localStorage.getItem('v13_data');
            if(s) document.getElementById('start-date').value = s;
            if(e) document.getElementById('end-date').value = e;
            if(d) tripData = JSON.parse(d);
            if(s && e) handleDateChange();
        }
    </script>
</body>
</html>